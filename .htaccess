############################################
# Core settings
############################################

RewriteEngine On
RewriteBase /

# Prioritera alltid PHP före HTML
DirectoryIndex index.php index.htm index.html

# Inaktivera directory listing
Options -Indexes

# Följ symboliska länkar
Options +FollowSymLinks


############################################
# URL Rewriting - Rena URLer
############################################

# /admin -> /cms/admin.php
RewriteRule ^admin/?$ cms/admin.php [L]

# /dashboard -> /cms/dashboard.php
RewriteRule ^dashboard/?$ cms/dashboard.php [L]

# /setup -> /setup.php
RewriteRule ^setup/?$ setup.php [L]

# /super-admin -> /cms/super-admin.php
RewriteRule ^super-admin/?$ cms/super-admin.php [L]

# /api/super -> /cms/api-super.php
RewriteRule ^api/super/?$ cms/api-super.php [QSA,L]

# /kontakt -> /kontakt.php
RewriteRule ^kontakt/?$ kontakt.php [L]

# /cookies -> /cookies.php
RewriteRule ^cookies/?$ cookies.php [L]

# /integritetspolicy -> /integritetspolicy.php
RewriteRule ^integritetspolicy/?$ integritetspolicy.php [L]

# /projekt -> /projekt.php
RewriteRule ^projekt/?$ projekt.php [L]

# /projekt/{slug} -> /projekt-single.php?slug={slug}
RewriteRule ^projekt/([a-z0-9-]+)/?$ projekt-single.php?slug=$1 [QSA,L]

# Ta bort .php från alla URLer (endast om filen finns)
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME}.php -f
RewriteRule ^(.+?)/?$ $1.php [L,QSA]


############################################
# Cache-strategi: prod men alltid uppdaterad
############################################

<IfModule mod_headers.c>

    # PHP & HTML – aldrig cache i browser
    <FilesMatch "\.(php|html)$">
        Header set Cache-Control "no-store, no-cache, must-revalidate, max-age=0"
        Header set Pragma "no-cache"
    </FilesMatch>

    # CSS & JS – alltid revalidera
    <FilesMatch "\.(css|js)$">
        Header set Cache-Control "no-cache, must-revalidate"
    </FilesMatch>

    # Bilder – lätt cache (1 dag)
    <FilesMatch "\.(jpg|jpeg|png|webp|svg|gif|ico)$">
        Header set Cache-Control "public, max-age=86400"
    </FilesMatch>

</IfModule>


############################################
# Säkerhetsheaders
############################################

<IfModule mod_headers.c>
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # Content Security Policy
    Header set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:;"

    # Remove server signature
    Header unset Server
    Header unset X-Powered-By
</IfModule>


############################################
# Skydda känsliga filer
############################################

<FilesMatch "^(\.env|\.git|\.htaccess|config\.php|composer\.(json|lock)|update-state\.json|backup-meta\.json)">
    Require all denied
</FilesMatch>

# Skydda data/backups och data/tmp
RewriteRule ^data/(backups|tmp)/ - [F,L]

# Förhindra PHP-exekvering i uploads (se uploads/.htaccess)
# OBS: <Directory> och php_value/php_flag är inte tillåtna i .htaccess på PHP-FPM-servrar
# PHP-inställningar hanteras via .user.ini


############################################
# Gzip Compression
############################################

<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
</IfModule>


############################################
# HTTPS Redirect (aktivera i produktion)
############################################

# RewriteCond %{HTTPS} off
# RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]


############################################
# Custom Error Pages
############################################

ErrorDocument 404 /404.php
ErrorDocument 403 /403.php
ErrorDocument 500 /500.php
